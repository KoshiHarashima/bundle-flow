# BundleFlow Model Documentation

## 記号と目的

### 基本記号
- **m**: 商品数
- **b ∈ {0,1}^m**: 束（離散）
- **x ∈ ℝ^m**: 連続束変数（ODE上での状態）
- **K**: メニュー要素数
- **D**: 初期分布の混合成分数

### 三層モデル構造

#### 1. 速度場 v_θ: ℝ^m × [0,1] → ℝ^m
- **目的**: 連続変数xをdx/dt=v_θ(x,t)で輸送し、x(1)の支持を{0,1}^mに寄せる
- **実装**: `FlowModel`クラス（QNet + EtaNet）
- **記号**: φ(t,s_t) = η(t)·Q(s0)·s_t （Eq.9）

#### 2. 初期分布 p_0(φ_k)
- **目的**: 各メニュー要素kごとに異なる初期分布パラメータφ_kを学習
- **実装**: `MenuElement`クラスの`mus`パラメータ
- **記号**: s0 ~ p_0(φ_k) = Σ_d w_d^(k) δ(μ_d^(k))

#### 3. メニュー価格 p_k
- **目的**: 各メニュー要素kの価格を学習
- **実装**: `MenuElement`クラスの`beta`パラメータ
- **記号**: p_k = softplus(β_k) ≥ 0

### 生成過程
1. **初期化**: z ~ p_0(φ_k)
2. **ODE積分**: dx/dt = v_θ(x,t), x(0) = z
3. **離散化**: b = I(x(1) ≥ 0.5) （評価専用）

### 目的関数
- **効用**: U(b;v) = v(b) - p_k
- **収入**: R = Σ_k z_k(v) · p_k
- **厚生**: W = Σ_k z_k(v) · v(b_k)

### 2段階学習
- **Stage 1**: 混合Gaussian（固定φ）でv_θの可行域学習
- **Stage 2**: メニューごとにsupportと重み（混合Dirac）＋価格を学習

### 制約と保証
- **DSIC**: メニューの自己依存排除・代理人最適化で担保（Rochet系）
- **IR制約**: U(b;v) ≥ 0 （Individual Rationality）
- **価格制約**: p_k ≥ 0 （softplusで保証）

### 比較静学パラメータ
- **外的変数**: m（商品数）、K（メニュー要素数）、温度（λ, τ）
- **内的変数**: φ_k（初期分布）、p_k（価格）、v_θ（速度場）

### Liouville方程式
密度重み: exp(-Tr[Q(s0)] ∫_0^T η(t)dt) （Eq.12）

### 数値安定化
- **log-sum-exp**: 効用計算の数値安定化
- **softplus**: 価格の非負制約
- **勾配クリッピング**: 学習安定化
- **スペクトル正規化**: Lipschitz制御
