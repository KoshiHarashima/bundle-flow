# ç¾å®Ÿçš„ãªStage2è¨­å®šã®ææ¡ˆ

## ðŸŽ¯ ç¾åœ¨ã®å•é¡Œç‚¹

### 1. å­¦ç¿’çŽ‡ãŒé«˜ã™ãŽã‚‹
```python
'lr': 3e-1,  # 0.3ã¯é«˜ã™ãŽã‚‹
```
**å•é¡Œ**: ä¾¡æ ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç™ºæ•£ã—ã€çµ±ä¸€ä¾¡æ ¼ï¼ˆ10.0ï¼‰ã«ãªã£ã¦ã—ã¾ã†

### 2. æ¸©åº¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãŒä¸é©åˆ‡
```python
'lam_start': 1e-3,  # é–‹å§‹æ¸©åº¦ãŒä½Žã™ãŽã‚‹
'lam_end': 0.1,     # çµ‚äº†æ¸©åº¦ã‚‚ä½Žã™ãŽã‚‹
```
**å•é¡Œ**: SoftmaxãŒç¡¬ã™ãŽã¦ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠžãŒç¡¬ç›´çš„ã«ãªã‚‹

### 3. å­¦ç¿’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸è¶³
```python
'iters': 500,  # ãƒ‡ãƒ¢ç”¨ã«çŸ­ç¸®ã—ã™ãŽ
```
**å•é¡Œ**: åŽå…¥æœ€é©åŒ–ãŒä¸ååˆ†

### 4. è©•ä¾¡é–¢æ•°ãŒå˜ç´”ã™ãŽã‚‹
```python
'a': 32,  # XORåŽŸå­æ•°ãŒå°‘ãªã™ãŽã‚‹
```
**å•é¡Œ**: ç¾å®Ÿçš„ãªè©•ä¾¡é–¢æ•°ã®è¤‡é›‘ã•ã‚’åæ˜ ã—ã¦ã„ãªã„

## ðŸ”§ æ”¹å–„ã•ã‚ŒãŸè¨­å®š

### ç¾å®Ÿçš„ãªStage2è¨­å®š

```python
# Stage2ã®è¨­å®šï¼ˆç¾å®Ÿçš„ãªã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰
stage2_config = {
    'K': 32,           # ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¦ç´ æ•°ï¼ˆä¸­è¦æ¨¡ï¼‰
    'D': 8,            # åˆæœŸåˆ†å¸ƒã®æ··åˆæˆåˆ†æ•°ï¼ˆã‚ˆã‚Šå¤šæ§˜ï¼‰
    'iters': 2000,     # ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°ï¼ˆååˆ†ãªå­¦ç¿’ï¼‰
    'batch': 64,       # ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆå®‰å®šæ€§é‡è¦–ï¼‰
    'lr': 5e-3,        # å­¦ç¿’çŽ‡ï¼ˆå®‰å®šã—ãŸå­¦ç¿’ï¼‰
    'lam_start': 0.1,  # SoftMaxæ¸©åº¦ã®é–‹å§‹å€¤ï¼ˆæŸ”è»Ÿãªé¸æŠžï¼‰
    'lam_end': 0.5,    # SoftMaxæ¸©åº¦ã®çµ‚äº†å€¤ï¼ˆé©åº¦ãªç¡¬ç›´åŒ–ï¼‰
    'ode_steps': 50,   # ODEç©åˆ†ã‚¹ãƒ†ãƒƒãƒ—æ•°ï¼ˆé«˜ç²¾åº¦ï¼‰
    'n_val': 500,      # è©•ä¾¡é–¢æ•°ã®æ•°ï¼ˆçµ±è¨ˆçš„ä¿¡é ¼æ€§ï¼‰
    'a': 64,           # XORåŽŸå­æ•°ï¼ˆç¾å®Ÿçš„ãªè¤‡é›‘ã•ï¼‰
    'seed': 42
}

print("ç¾å®Ÿçš„ãªStage2è¨­å®š:")
for key, value in stage2_config.items():
    print(f"  {key}: {value}")
```

## ðŸ“Š è¨­å®šå¤‰æ›´ã®æ ¹æ‹ 

### 1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¦ç´ æ•°: 16 â†’ 32
**ç†ç”±**: 
- ã‚ˆã‚Šå¤šæ§˜ãªä¾¡æ ¼å¸¯ã‚’æä¾›
- ä¾¡æ ¼å·®åˆ¥æˆ¦ç•¥ã®å®Ÿç¾
- é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç´°åˆ†åŒ–

**çµŒæ¸ˆå­¦çš„æ„å‘³**: å¸‚å ´ã®åŽšã¿ã‚’å¢—ã—ã€ã‚ˆã‚ŠåŠ¹çŽ‡çš„ãªè³‡æºé…åˆ†ã‚’å®Ÿç¾

### 2. æ··åˆæˆåˆ†æ•°: 4 â†’ 8
**ç†ç”±**:
- ã‚ˆã‚Šå¤šæ§˜ãªåˆæœŸåˆ†å¸ƒ
- æŸç”Ÿæˆã®å¤šæ§˜æ€§å‘ä¸Š
- å±€æ‰€æœ€é©è§£ã®å›žé¿

**çµŒæ¸ˆå­¦çš„æ„å‘³**: ã‚ˆã‚Šå¤šæ§˜ãªæŸã‚’ç”Ÿæˆã—ã€ç•°ãªã‚‹é¸å¥½ã«å¯¾å¿œ

### 3. å­¦ç¿’çŽ‡: 3e-1 â†’ 5e-3
**ç†ç”±**:
- ä¾¡æ ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å®‰å®šã—ãŸå­¦ç¿’
- ç™ºæ•£ã®é˜²æ­¢
- ç´°ã‹ã„ä¾¡æ ¼èª¿æ•´ã®å®Ÿç¾

**çµŒæ¸ˆå­¦çš„æ„å‘³**: ä¾¡æ ¼ã®å¾®èª¿æ•´ã«ã‚ˆã‚Šã€ã‚ˆã‚Šç²¾å¯†ãªä¾¡æ ¼å·®åˆ¥ãŒå¯èƒ½

### 4. æ¸©åº¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°: 1e-3-0.1 â†’ 0.1-0.5
**ç†ç”±**:
- æŸ”è»Ÿãªãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠžã‹ã‚‰ç¡¬ç›´çš„ãªé¸æŠžã¸
- å­¦ç¿’åˆæœŸã®æŽ¢ç´¢ã¨å¾ŒæœŸã®æ´»ç”¨ã®ãƒãƒ©ãƒ³ã‚¹
- åŽå…¥æœ€é©åŒ–ã®æ”¹å–„

**çµŒæ¸ˆå­¦çš„æ„å‘³**: å­¦ç¿’åˆæœŸã¯å¤šæ§˜ãªé¸æŠžã‚’æŽ¢ç´¢ã—ã€å¾ŒæœŸã¯æœ€é©è§£ã«åŽæŸ

### 5. å­¦ç¿’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 500 â†’ 2000
**ç†ç”±**:
- ååˆ†ãªåŽå…¥æœ€é©åŒ–
- ä¾¡æ ¼ã¨åˆæœŸåˆ†å¸ƒã®é©åˆ‡ãªèª¿æ•´
- åŽæŸã®ä¿è¨¼

**çµŒæ¸ˆå­¦çš„æ„å‘³**: ã‚ˆã‚ŠåŠ¹çŽ‡çš„ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­è¨ˆã«ã‚ˆã‚Šã€åŽå…¥æœ€å¤§åŒ–ã‚’å®Ÿç¾

### 6. ODEç©åˆ†ã‚¹ãƒ†ãƒƒãƒ—: 25 â†’ 50
**ç†ç”±**:
- ã‚ˆã‚Šé«˜ç²¾åº¦ãªæŸç”Ÿæˆ
- æ•°å€¤ç©åˆ†ã®å®‰å®šæ€§å‘ä¸Š
- æŸã®å“è³ªå‘ä¸Š

**çµŒæ¸ˆå­¦çš„æ„å‘³**: ã‚ˆã‚Šæ­£ç¢ºãªæŸç”Ÿæˆã«ã‚ˆã‚Šã€åŠ¹çŽ‡çš„ãªè³‡æºé…åˆ†ã‚’å®Ÿç¾

### 7. è©•ä¾¡é–¢æ•°æ•°: 200 â†’ 500
**ç†ç”±**:
- çµ±è¨ˆçš„ä¿¡é ¼æ€§ã®å‘ä¸Š
- ã‚ˆã‚Šå¤šæ§˜ãªè©•ä¾¡é–¢æ•°åˆ†å¸ƒ
- å …ç‰¢æ€§ã®å‘ä¸Š

**çµŒæ¸ˆå­¦çš„æ„å‘³**: ã‚ˆã‚Šå¤šæ§˜ãªå¸‚å ´ç’°å¢ƒã§ã®æ€§èƒ½è©•ä¾¡

### 8. XORåŽŸå­æ•°: 32 â†’ 64
**ç†ç”±**:
- ã‚ˆã‚Šç¾å®Ÿçš„ãªè©•ä¾¡é–¢æ•°ã®è¤‡é›‘ã•
- å•†å“é–“ã®è¤‡é›‘ãªé–¢ä¿‚æ€§
- ã‚ˆã‚ŠæŒ‘æˆ¦çš„ãªæœ€é©åŒ–å•é¡Œ

**çµŒæ¸ˆå­¦çš„æ„å‘³**: ç¾å®Ÿã®ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã«è¿‘ã„è¤‡é›‘ãªè©•ä¾¡é–¢æ•°ã§ã®æ€§èƒ½

## ðŸŽ¯ æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„çµæžœ

### 1. ä¾¡æ ¼åˆ†å¸ƒã®æ”¹å–„
```python
# æœŸå¾…ã•ã‚Œã‚‹çµæžœ
ä¾¡æ ¼ã®çµ±è¨ˆ: min=0.1234, max=4.5678, mean=1.2345
```
- å¤šæ§˜ãªä¾¡æ ¼å¸¯ã®å®Ÿç¾
- ä¾¡æ ¼å·®åˆ¥æˆ¦ç•¥ã®æˆåŠŸ
- é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¸ã®å¯¾å¿œ

### 2. æŸç”Ÿæˆã®æ”¹å–„
```python
# æœŸå¾…ã•ã‚Œã‚‹çµæžœ
æŸã‚µã‚¤ã‚ºã®çµ±è¨ˆ: min=1.0, max=6.0, mean=3.2
å¤šæ§˜æ€§ã®çµ±è¨ˆ: min=0.400, max=0.800, mean=0.600
```
- ç©ºã§ãªã„æŸã®ç”Ÿæˆ
- ã‚ˆã‚Šå¤šæ§˜ãªæŸã®ç”Ÿæˆ
- åŠ¹çŽ‡çš„ãªè³‡æºé…åˆ†

### 3. åŽå…¥æ€§èƒ½ã®æ”¹å–„
```python
# æœŸå¾…ã•ã‚Œã‚‹çµæžœ
æœŸå¾…åŽå…¥: 15.2345
ãƒãƒ¼ãƒ‰å‰²å½“åŽå…¥: 12.3456
å¹³å‡åŠ¹ç”¨: 8.7654
IRåˆ¶ç´„æº€è¶³çŽ‡: 0.8500
```
- æœŸå¾…åŽå…¥ã¨ãƒãƒ¼ãƒ‰å‰²å½“åŽå…¥ã®ä¹–é›¢ç¸®å°
- å®Ÿéš›ã®å–å¼•ã®ç™ºç”Ÿ
- é©åˆ‡ãªIRåˆ¶ç´„æº€è¶³çŽ‡

## ðŸš€ å®Ÿè£…ã®æŽ¨å¥¨äº‹é …

### 1. æ®µéšŽçš„ãªèª¿æ•´
```python
# æ®µéšŽ1: å­¦ç¿’çŽ‡ã®èª¿æ•´
stage2_config['lr'] = 1e-2

# æ®µéšŽ2: æ¸©åº¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã®èª¿æ•´
stage2_config['lam_start'] = 0.05
stage2_config['lam_end'] = 0.3

# æ®µéšŽ3: ãã®ä»–ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´
stage2_config['iters'] = 1000
```

### 2. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
```python
# å­¦ç¿’éŽç¨‹ã®ç›£è¦–
if it % 100 == 0:
    # ä¾¡æ ¼åˆ†å¸ƒã®ç¢ºèª
    prices = [elem.price().detach().item() for elem in menu[:-1]]
    print(f"ä¾¡æ ¼ç¯„å›²: {min(prices):.4f} - {max(prices):.4f}")
    
    # æŸç”Ÿæˆã®ç¢ºèª
    with torch.no_grad():
        test_bundles = generate_test_bundles(flow, menu)
        print(f"æŸã®å¤šæ§˜æ€§: {calculate_diversity(test_bundles):.3f}")
```

### 3. æ—©æœŸåœæ­¢
```python
# åŽå…¥ã®æ”¹å–„ãŒæ­¢ã¾ã£ãŸå ´åˆã®æ—©æœŸåœæ­¢
if len(revenues) > 100:
    recent_improvement = max(revenues[-100:]) - min(revenues[-100:])
    if recent_improvement < 1e-4:
        print("åŽå…¥æ”¹å–„ãŒåœæ»žã€‚æ—©æœŸåœæ­¢ã€‚")
        break
```

## ðŸ“ˆ çµŒæ¸ˆå­¦çš„æœŸå¾…åŠ¹æžœ

### 1. åŠ¹çŽ‡æ€§ã®å‘ä¸Š
- **Allocative Efficiency**: ã‚ˆã‚ŠåŠ¹çŽ‡çš„ãªè³‡æºé…åˆ†
- **Revenue Efficiency**: åŽå…¥ã®æœ€å¤§åŒ–
- **Social Welfare**: ç¤¾ä¼šçš„åŽšç”Ÿã®å‘ä¸Š

### 2. å…¬å¹³æ€§ã®æ”¹å–„
- **Price Discrimination**: é©åˆ‡ãªä¾¡æ ¼å·®åˆ¥
- **Market Access**: ã‚ˆã‚Šå¤šãã®é¡§å®¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
- **Competition**: ç«¶äº‰ã®ä¿ƒé€²

### 3. å®‰å®šæ€§ã®å‘ä¸Š
- **Robustness**: ç•°ãªã‚‹è©•ä¾¡é–¢æ•°åˆ†å¸ƒã§ã®å®‰å®šæ€§
- **Scalability**: ã‚ˆã‚Šå¤§ããªå•é¡Œã¸ã®å¯¾å¿œ
- **Real-time Performance**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®é©ç”¨

ã“ã®æ”¹å–„ã•ã‚ŒãŸè¨­å®šã«ã‚ˆã‚Šã€BundleFlowã¯ã‚ˆã‚Šç¾å®Ÿçš„ã§å®Ÿç”¨çš„ãªã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ã€‚

